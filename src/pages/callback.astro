---
import { getAccessToken } from '../utils/spotifyAuth';

const url = new URL(Astro.request.url);
const code = url.searchParams.get('code');
const error = url.searchParams.get('error');

let userData = null;
let libraryData = null;

if (code) {
  try {
    const tokenData = await getAccessToken(code);
    
    // Guardar tokens en cookies
    Astro.cookies.set('spotify_access_token', tokenData.access_token, {
      path: '/',
      maxAge: tokenData.expires_in,
      httpOnly: true,
      secure: true
    });
    
    if (tokenData.refresh_token) {
      Astro.cookies.set('spotify_refresh_token', tokenData.refresh_token, {
        path: '/',
        maxAge: 60 * 60 * 24 * 365, // 1 año
        httpOnly: true,
        secure: true
      });
    }

    // Redirigir a la página principal
    return Astro.redirect('/');
    
  } catch (error) {
    console.error('Error in callback:', error);
  }
}
---

<html lang="es">
  <head>
    <title>Autenticando...</title>
  </head>
  <body>
    <div class="flex items-center justify-center min-h-screen">
      {error ? (
        <div class="text-red-500">
          Error de autenticación: {error}
        </div>
      ) : (
        <div class="text-white">
          Autenticando...
        </div>
      )}
    </div>
  </body>
</html>